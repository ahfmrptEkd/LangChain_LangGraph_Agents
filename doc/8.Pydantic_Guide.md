# ğŸ›¡ï¸ Pydantic í•µì‹¬ ê°€ì´ë“œ for LangChain

> LangChainì—ì„œ êµ¬ì¡°í™”ëœ ì¶œë ¥ê³¼ ë°ì´í„° ê²€ì¦ì„ ìœ„í•œ Pydantic í•µì‹¬ í™œìš©ë²•

## ğŸ“š ëª©ì°¨

- [ê¸°ë³¸ ê°œë…](#-ê¸°ë³¸-ê°œë…)
- [BaseModel ì‚¬ìš©ë²•](#-basemodel-ì‚¬ìš©ë²•)
- [Field ê²€ì¦](#-field-ê²€ì¦)
- [Validator](#-validator)
- [LangChain í†µí•©](#-langchain-í†µí•©)
- [ì‹¤ì „ íŒ¨í„´](#-ì‹¤ì „-íŒ¨í„´)
- [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ğŸ¯ ê¸°ë³¸ ê°œë…

**Pydantic**ì€ Python íƒ€ì… íŒíŠ¸ë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ê²€ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.

### LangChainì—ì„œì˜ ì—­í• 
```python
# ê¸°ë³¸ íë¦„
LLM ì¶œë ¥ â†’ Pydantic ëª¨ë¸ â†’ êµ¬ì¡°í™”ëœ ë°ì´í„° â†’ ì• í”Œë¦¬ì¼€ì´ì…˜
```

### í•µì‹¬ ì¥ì 
- âœ… **íƒ€ì… ì•ˆì „ì„±**: ìë™ íƒ€ì… ê²€ì¦
- âœ… **IDE ì§€ì›**: ìë™ì™„ì„±, íƒ€ì… ì²´í¬
- âœ… **JSON í˜¸í™˜**: ìë™ ì§ë ¬í™”/ì—­ì§ë ¬í™”

---

## ğŸ—ï¸ BaseModel ì‚¬ìš©ë²•

### ê¸°ë³¸ ëª¨ë¸ ì •ì˜
```python
from pydantic import BaseModel, Field
from typing import Optional, List

class Person(BaseModel):
    name: str
    age: int
    email: Optional[str] = None
    is_active: bool = True

# ì‚¬ìš© ì˜ˆì‹œ
person = Person(name="ê¹€ì² ìˆ˜", age=30)
print(person.model_dump())  # ë”•ì…”ë„ˆë¦¬ ë³€í™˜
print(person.model_dump_json())  # JSON ë³€í™˜
```

### ì¤‘ì²© ëª¨ë¸
```python
class Address(BaseModel):
    city: str
    country: str = "í•œêµ­"

class User(BaseModel):
    name: str
    address: Address
    friends: List[str] = Field(default_factory=list)
```

---

## ğŸ”§ Field ê²€ì¦

### ì£¼ìš” ê²€ì¦ ì˜µì…˜
```python
class Product(BaseModel):
    name: str = Field(min_length=1, max_length=100)
    price: float = Field(gt=0, description="ê°€ê²© (ì›)")
    tags: List[str] = Field(max_length=10)
    category: str = Field(pattern=r'^[a-zA-Zê°€-í£]+$')
```

### Field ì œì•½ì¡°ê±´ ìš”ì•½

| íƒ€ì… | ì œì•½ì¡°ê±´ | ì˜ˆì‹œ |
|------|----------|------|
| **ë¬¸ìì—´** | `min_length`, `max_length`, `pattern` | `Field(min_length=1, pattern=r'^\d+$')` |
| **ìˆ«ì** | `gt`, `ge`, `lt`, `le` | `Field(gt=0, le=100)` |
| **ë¦¬ìŠ¤íŠ¸** | `min_length`, `max_length` | `Field(max_length=10)` |

### Enum í™œìš©
```python
from enum import Enum

class UserRole(str, Enum):
    ADMIN = "admin"
    USER = "user"

class User(BaseModel):
    name: str
    role: UserRole = UserRole.USER
```

---

## ğŸ›¡ï¸ Validator

### @field_validator (í•„ë“œë³„ ê²€ì¦)
```python
from pydantic import BaseModel, field_validator

class User(BaseModel):
    name: str
    email: str
    
    @field_validator('name')
    @classmethod
    def validate_name(cls, v):
        if not v.strip():
            raise ValueError('ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤')
        return v.strip()
    
    @field_validator('email')
    @classmethod
    def validate_email(cls, v):
        if '@' not in v:
            raise ValueError('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤')
        return v.lower()
```

### @model_validator (ëª¨ë¸ ì „ì²´ ê²€ì¦)
```python
from pydantic import BaseModel, model_validator

class ExtractedData(BaseModel):
    people: List[dict] = Field(default_factory=list)
    companies: List[dict] = Field(default_factory=list)
    
    @model_validator(mode='before')
    @classmethod
    def handle_none_values(cls, data):
        """LLMì˜ None ë°˜í™˜ ì²˜ë¦¬"""
        if isinstance(data, dict):
            if data.get('people') is None:
                data['people'] = []
            if data.get('companies') is None:
                data['companies'] = []
        return data
    
    @model_validator(mode='after')
    @classmethod
    def validate_content(cls, model):
        """ìµœì†Œ í•˜ë‚˜ì˜ ë°ì´í„° ë³´ì¥"""
        if not model.people and not model.companies:
            raise ValueError('ìµœì†Œ í•˜ë‚˜ì˜ ì •ë³´ëŠ” í•„ìš”í•©ë‹ˆë‹¤')
        return model
```

### Validator ëª¨ë“œ ë¹„êµ

| ëª¨ë“œ | ì‹¤í–‰ ì‹œì  | ìš©ë„ | ì˜ˆì‹œ |
|------|----------|------|------|
| `mode='before'` | í•„ë“œ ê²€ì¦ ì „ | ë°ì´í„° ì „ì²˜ë¦¬ | None â†’ [] ë³€í™˜ |
| `mode='after'` | í•„ë“œ ê²€ì¦ í›„ | ëª¨ë¸ ê°„ ê´€ê³„ ê²€ì¦ | í•„ë“œ ê°„ ì¼ê´€ì„± ì²´í¬ |

---

## ğŸ”— LangChain í†µí•©

### with_structured_output í™œìš©
```python
from langchain_openai import ChatOpenAI

class ReviewAnalysis(BaseModel):
    title: str = Field(description="ì œí’ˆëª…")
    rating: int = Field(ge=1, le=5, description="í‰ì  (1-5)")
    sentiment: str = Field(description="ê°ì • ë¶„ì„")
    is_recommended: bool = Field(description="ì¶”ì²œ ì—¬ë¶€")

# LLM ì—°ê²°
llm = ChatOpenAI(model="gpt-4o-mini")
structured_llm = llm.with_structured_output(
    schema=ReviewAnalysis,
    method="function_calling"
)

# ì‚¬ìš©
result = structured_llm.invoke("ì´ ì œí’ˆì€ ì •ë§ ì¢‹ì•„ìš”! 5ì  ë§Œì ì— 5ì !")
print(result.title)  # êµ¬ì¡°í™”ëœ ë°ì´í„° ì ‘ê·¼
```

### ë³µì¡í•œ ì¶”ì¶œ ì˜ˆì‹œ
```python
from typing import Literal

class NewsAnalysis(BaseModel):
    title: str = Field(description="ê¸°ì‚¬ ì œëª©")
    people: List[str] = Field(default_factory=list, description="ì–¸ê¸‰ëœ ì¸ë¬¼")
    sentiment: Literal["positive", "negative", "neutral"] = Field(description="ê°ì •")
    
    @model_validator(mode='before')
    @classmethod
    def clean_data(cls, data):
        # LLM ì¶œë ¥ ì •ë¦¬ ë¡œì§
        return data
```

---

## ğŸ¯ ì‹¤ì „ íŒ¨í„´

### 1. ì¡°ê±´ë¶€ ê²€ì¦
```python
class UserProfile(BaseModel):
    user_type: Literal["individual", "business"]
    name: str
    age: Optional[int] = None
    company: Optional[str] = None
    
    @model_validator(mode='after')
    @classmethod
    def validate_by_type(cls, model):
        if model.user_type == "individual" and not model.age:
            raise ValueError("ê°œì¸ ì‚¬ìš©ìëŠ” ë‚˜ì´ê°€ í•„ìš”í•©ë‹ˆë‹¤")
        if model.user_type == "business" and not model.company:
            raise ValueError("ë¹„ì¦ˆë‹ˆìŠ¤ ì‚¬ìš©ìëŠ” íšŒì‚¬ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤")
        return model
```

### 2. ì•ˆì „í•œ ë°ì´í„° ì²˜ë¦¬
```python
class SafeExtractionModel(BaseModel):
    name: Optional[str] = None
    age: Optional[int] = None
    
    @field_validator('age')
    @classmethod
    def safe_age_conversion(cls, v):
        if v is None:
            return None
        try:
            age = int(v)
            return age if 0 <= age <= 150 else None
        except:
            return None
```

### 3. ì„±ëŠ¥ ìµœì í™”
```python
class OptimizedModel(BaseModel):
    model_config = {
        'validate_assignment': False,  # ì¬ê²€ì¦ ë¹„í™œì„±í™”
        'use_enum_values': True,       # Enum ê°’ ì§ì ‘ ì‚¬ìš©
    }
    
    name: str
    status: UserRole
```

---

## ğŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜

#### 1. ValidationError: Input should be a valid list
```python
# âŒ ë¬¸ì œ: LLMì´ None ë°˜í™˜
# âœ… í•´ê²°: model_validatorë¡œ ì²˜ë¦¬
@model_validator(mode='before')
@classmethod
def handle_none(cls, data):
    if isinstance(data, dict):
        for key, value in data.items():
            if value is None and key in ['list_field1', 'list_field2']:
                data[key] = []
    return data
```

#### 2. í•œêµ­ì–´ ê²€ì¦ ì˜¤ë¥˜
```python
# âœ… í•œêµ­ì–´ ì¹œí™”ì  ê²€ì¦
@field_validator('name')
@classmethod
def validate_korean_name(cls, v):
    import re
    if not re.match(r'^[ê°€-í£a-zA-Z\s]+$', v):
        raise ValueError('í•œê¸€ ë˜ëŠ” ì˜ë¬¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤')
    return v.strip()
```

### ë””ë²„ê¹… íŒ
```python
# 1. ìŠ¤í‚¤ë§ˆ í™•ì¸
print(MyModel.model_json_schema())

# 2. ê²€ì¦ ì˜¤ë¥˜ í™•ì¸
try:
    model = MyModel(**data)
except ValidationError as e:
    for error in e.errors():
        print(f"Field: {error['loc']}, Error: {error['msg']}")

# 3. ëª¨ë¸ ìƒíƒœ í™•ì¸
print(model.model_dump())
print(model.model_dump_json(indent=2))
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Pydantic ê³µì‹ ë¬¸ì„œ](https://docs.pydantic.dev/)
- [LangChain Structured Output](https://python.langchain.com/docs/how_to/structured_output/)

---

*Pydantic v2ì™€ LangChain v0.3+ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.* 