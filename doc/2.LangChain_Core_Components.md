# LangChain Core Components Guide

## ğŸ“š ëª©ì°¨

- [Overview](#overview)
- [1. Data Passing & Flow](#1--data-passing--flow)
  - [RunnablePassthrough](#runnablepassthrough)
  - [itemgetter](#itemgetter)
  - [RunnablePassthrough vs itemgetter](#runnablepassthrough-vs-itemgetter)
- [2. Document Serialization: dumps & loads](#2--document-serialization-dumps--loads)
- [3. Retriever Methods: invoke vs get_relevant_documents](#3--retriever-methods-invoke-vs-get_relevant_documents)
- [4. Few-Shot Prompting: FewShotChatMessagePromptTemplate](#4--few-shot-prompting-fewshotchatmessagepromptemplate)
- [Best Practices & Summary](#-best-practices--summary)

---

## Overview
Query Translationê³¼ RAG êµ¬í˜„ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” LangChainì˜ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë“¤ì— ëŒ€í•œ ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤. ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œì™€ í•¨ê»˜ ê° ì»´í¬ë„ŒíŠ¸ì˜ ì—­í• ê³¼ í™œìš©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

## 1. ğŸ”— Data Passing & Flow

### `RunnablePassthrough`
ì…ë ¥ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì¶œë ¥ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤. ë‹¨ìˆœí•œ íŒŒì´í”„ë¼ì¸ì—ì„œ ì›ë³¸ ì…ë ¥ì„ ìœ ì§€í•˜ë©° ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.

**ì£¼ìš” íŠ¹ì§•:**
- **ë‹¨ìˆœì„±**: ì…ë ¥ê°’ì„ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ì—¬ íŒŒì´í”„ë¼ì¸ êµ¬ì¡°ë¥¼ ëª…í™•í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
- **í™œìš©**: ì£¼ë¡œ `{"context": retriever, "question": RunnablePassthrough()}`ì™€ ê°™ì´, ê²€ìƒ‰ëœ `context`ì™€ ì›ë³¸ `question`ì„ í•¨ê»˜ í”„ë¡¬í”„íŠ¸ì— ì „ë‹¬í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

**ì‚¬ìš© ì˜ˆì‹œ:**
```python
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser

# ë‹¨ìˆœí•œ RAG ì²´ì¸
simple_rag_chain = (
    {"context": retriever | format_docs, "question": RunnablePassthrough()}
    | prompt
    | llm
    | StrOutputParser()
)

# ì‚¬ìš© ì‹œ "What is task decomposition?" ë¬¸ìì—´ì´ questionìœ¼ë¡œ ê·¸ëŒ€ë¡œ ì „ë‹¬ë¨
result = simple_rag_chain.invoke("What is task decomposition?")
```

### `itemgetter`
ë³µì¡í•œ ë°ì´í„° êµ¬ì¡°(ì£¼ë¡œ ë”•ì…”ë„ˆë¦¬)ì—ì„œ íŠ¹ì • í‚¤ì˜ ê°’ì„ ì¶”ì¶œí•˜ëŠ” íŒŒì´ì¬ ë‚´ì¥ í•¨ìˆ˜ì…ë‹ˆë‹¤. LangChain íŒŒì´í”„ë¼ì¸ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©ë©ë‹ˆë‹¤.

**ì£¼ìš” íŠ¹ì§•:**
- **ê°’ ì¶”ì¶œ**: `itemgetter("key")`ëŠ” `lambda x: x["key"]`ì™€ ë™ì¼í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.
- **ë³µì¡í•œ íŒŒì´í”„ë¼ì¸**: ì…ë ¥ì´ ë”•ì…”ë„ˆë¦¬ í˜•íƒœì¼ ë•Œ `RunnablePassthrough`ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê³  íŠ¹ì • ê°’ì„ ì •í™•íˆ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì‚¬ìš© ì˜ˆì‹œ:**
```python
from operator import itemgetter

# Multi-Query RAGì™€ ê°™ì´ ì…ë ¥ì´ {"question": "..."} í˜•íƒœì¼ ë•Œ
final_rag_chain = (
    {"context": retrieval_chain, "question": itemgetter("question")}
    | prompt | llm | StrOutputParser()
)

# itemgetterê°€ ë”•ì…”ë„ˆë¦¬ì—ì„œ "question" í‚¤ì˜ ê°’ì„ ì¶”ì¶œí•˜ì—¬ ì „ë‹¬
result = final_rag_chain.invoke({"question": "What is task decomposition?"})
```

### `RunnablePassthrough` vs `itemgetter`

| êµ¬ë¶„ | `RunnablePassthrough` | `itemgetter` |
|---|---|---|
| **ì…ë ¥ í˜•íƒœ** | ì£¼ë¡œ ë¬¸ìì—´ (String) | ì£¼ë¡œ ë”•ì…”ë„ˆë¦¬ (Dict) |
| **ì—­í• ** | ì…ë ¥ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬ | ë”•ì…”ë„ˆë¦¬ì—ì„œ íŠ¹ì • ê°’ ì¶”ì¶œ |
| **ì£¼ ì‚¬ìš©ì²˜** | `chain.invoke("query")` | `chain.invoke({"key": "value"})` |
| **ì£¼ì˜ì‚¬í•­** | ì…ë ¥ì´ ë”•ì…”ë„ˆë¦¬ì¼ ë•Œ ì˜ë„ì¹˜ ì•Šê²Œ ì „ì²´ ë”•ì…”ë„ˆë¦¬ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŒ | |

## 2. ğŸ”„ Document Serialization: `dumps` & `loads`

Document ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜(`dumps`)í•˜ê±°ë‚˜ ë‹¤ì‹œ Document ê°ì²´ë¡œ ë³µì›(`loads`)í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. ê°ì²´ëŠ” ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ ë‹¬ë¼ ì§ì ‘ ë¹„êµê°€ ì–´ë µê¸° ë•Œë¬¸ì—, ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí•´ì•¼ í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

**ì£¼ìš” íŠ¹ì§•:**
- **`dumps`**: Document ê°ì²´ â†’ ê³ ìœ í•œ ë¬¸ìì—´ë¡œ ë³€í™˜
- **`loads`**: ë¬¸ìì—´ â†’ ì›ë³¸ Document ê°ì²´ë¡œ ë³µì›

**í•µì‹¬ ì‚¬ìš© ì‚¬ë¡€: Multi-Query RAGì—ì„œ ì¤‘ë³µ ë¬¸ì„œ ì œê±°**
```python
from langchain.load import dumps, loads

def get_unique_union(documents: list[list]):
    """ì—¬ëŸ¬ ì¿¼ë¦¬ ê²°ê³¼ì—ì„œ ì¤‘ë³µëœ ë¬¸ì„œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤."""
    # 1. ëª¨ë“  Documentë¥¼ ë¹„êµ ê°€ëŠ¥í•œ ë¬¸ìì—´ë¡œ ë³€í™˜
    flattened_docs = [dumps(doc) for sublist in documents for doc in sublist]
    
    # 2. set()ì„ ì‚¬ìš©í•´ ê³ ìœ í•œ ë¬¸ìì—´ë§Œ ë‚¨ê¹€
    unique_docs_str = list(set(flattened_docs))
    
    # 3. ë‹¤ì‹œ Document ê°ì²´ë¡œ ë³µì›
    return [loads(doc_str) for doc_str in unique_docs_str]
```

## 3. ğŸ” Retriever Methods: `invoke` vs `get_relevant_documents`

`MultiVectorRetriever`ì™€ ê°™ì€ Retriever í´ë˜ìŠ¤ì—ì„œ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ëŠ” ë‘ ê°€ì§€ ì£¼ìš” ë©”ì†Œë“œì…ë‹ˆë‹¤.

### ë©”ì†Œë“œ ë¹„êµ

| êµ¬ë¶„ | `get_relevant_documents` (ë ˆê±°ì‹œ) | `invoke` (í˜„ëŒ€ì  ë°©ì‹) |
|---|---|---|
| **ë§¤ê°œë³€ìˆ˜ ì „ë‹¬** | í˜¸ì¶œ ì‹œ `retriever.get_relevant_documents(query, k=3)`ì²˜ëŸ¼ ì§ì ‘ ì „ë‹¬ | ìƒì„± ì‹œ `search_kwargs={"k": 3}`ë¡œ ë¯¸ë¦¬ ì§€ì • |
| **ì¿¼ë¦¬ í˜•ì‹** | ë¬¸ìì—´ + ì¶”ê°€ ë§¤ê°œë³€ìˆ˜ | ë¬¸ìì—´ë§Œ (`retriever.invoke(query)`) |
| **ì¥ì ** | í˜¸ì¶œë§ˆë‹¤ ë‹¤ë¥¸ ë§¤ê°œë³€ìˆ˜ ì‚¬ìš© ê°€ëŠ¥ (ìœ ì—°ì„±) | ì„¤ì •ê³¼ ì‚¬ìš©ì´ ë¶„ë¦¬ë˜ì–´ ì½”ë“œê°€ ê¹”ë”í•˜ê³ , LCEL íŒŒì´í”„ë¼ì¸ê³¼ í˜¸í™˜ì„±ì´ ë†’ìŒ |
| **ê¶Œì¥ì‚¬í•­** | **`invoke`** ì‚¬ìš©ì„ ê¶Œì¥. ì¼ê´€ì„±, ê°€ë…ì„±, íŒŒì´í”„ë¼ì¸ í†µí•©ì— ìœ ë¦¬ |

### ì‚¬ìš© ì˜ˆì‹œ

**`invoke` (ê¶Œì¥)**
```python
# 1. ìƒì„± ë‹¨ê³„ì—ì„œ ê²€ìƒ‰ ì˜µì…˜ ì„¤ì •
retriever = MultiVectorRetriever(
    vectorstore=vectorstore,
    byte_store=store,
    id_key="doc_id",
    search_kwargs={"k": 1}  # ê²€ìƒ‰ ê²°ê³¼ 1ê°œë¡œ ê³ ì •
)

# 2. ì‚¬ìš© ë‹¨ê³„ì—ì„œëŠ” ì¿¼ë¦¬ë§Œ ì „ë‹¬
results = retriever.invoke("ì—ì´ì „íŠ¸ì˜ ë©”ëª¨ë¦¬ êµ¬ì¡°")
```

**`get_relevant_documents`**
```python
# í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ê²€ìƒ‰ ì˜µì…˜ ì§€ì •
docs1 = retriever.get_relevant_documents("ì¿¼ë¦¬1", n_results=1)
docs2 = retriever.get_relevant_documents("ì¿¼ë¦¬2", n_results=5)
```

## 4. ğŸ¯ Few-Shot Prompting: `FewShotChatMessagePromptTemplate`

AI ëª¨ë¸ì—ê²Œ ëª‡ ê°€ì§€ ì˜ˆì‹œ(Few-shot)ë¥¼ ì œê³µí•˜ì—¬ ì›í•˜ëŠ” ì¶œë ¥ í˜•ì‹ì„ ëª…í™•íˆ ì•Œë ¤ì£¼ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤. ë³µì¡í•œ íƒœìŠ¤í¬ë‚˜ íŠ¹ì • ìŠ¤íƒ€ì¼ì˜ ì‘ë‹µì´ í•„ìš”í•  ë•Œ íš¨ê³¼ì ì…ë‹ˆë‹¤.

### êµ¬ì¡° ë° ì‹¤ì œ ì˜ˆì‹œ (Step-back Prompting)

```python
from langchain_core.prompts import ChatPromptTemplate, FewShotChatMessagePromptTemplate

# 1. ì˜ˆì‹œ ë°ì´í„° ì •ì˜ (êµ¬ì²´ì  ì§ˆë¬¸ -> ì¼ë°˜ì  ì§ˆë¬¸)
examples = [
    {"input": "Could the members of The Police perform lawful arrests?", "output": "what can the members of The Police do?"},
    {"input": "Jan Sindel's was born in what country?", "output": "what is Jan Sindel's personal history?"},
]

# 2. ê° ì˜ˆì‹œì˜ í˜•ì‹ì„ ì •ì˜í•˜ëŠ” í…œí”Œë¦¿
example_prompt = ChatPromptTemplate.from_messages([
    ("human", "{input}"),
    ("ai", "{output}"),
])

# 3. Few-Shot í…œí”Œë¦¿ ìƒì„±
few_shot_prompt = FewShotChatMessagePromptTemplate(
    example_prompt=example_prompt,
    examples=examples,
)

# 4. ìµœì¢… í”„ë¡¬í”„íŠ¸ì— ì‹œìŠ¤í…œ ë©”ì‹œì§€, Few-Shot ì˜ˆì‹œ, ì‚¬ìš©ì ì§ˆë¬¸ì„ ê²°í•©
final_prompt = ChatPromptTemplate.from_messages([
    ("system", "You are an expert at paraphrasing questions. Here are a few examples:"),
    few_shot_prompt,  # ì˜ˆì‹œë“¤ì´ ì—¬ê¸°ì— ì‚½ì…ë¨
    ("user", "{question}"),
])

# í”„ë¡¬í”„íŠ¸ ì²´ì¸ê³¼ ì—°ê²°í•˜ì—¬ ì‚¬ìš©
prompt_chain = final_prompt | llm
```

## ğŸ“ Best Practices & Summary

| ì»´í¬ë„ŒíŠ¸ | ì£¼ìš” ê¸°ëŠ¥ | ê¶Œì¥ ì‚¬ìš©ì²˜ |
|---|---|---|
| **`RunnablePassthrough`** | ë°ì´í„° ê·¸ëŒ€ë¡œ ì „ë‹¬ | ë‹¨ìˆœ RAG ì²´ì¸, `invoke`ì— ë¬¸ìì—´ì„ ì§ì ‘ ì „ë‹¬í•  ë•Œ |
| **`itemgetter`** | ë”•ì…”ë„ˆë¦¬ì—ì„œ ê°’ ì¶”ì¶œ | ë³µì¡í•œ RAG ì²´ì¸, `invoke`ì— ë”•ì…”ë„ˆë¦¬ë¥¼ ì „ë‹¬í•  ë•Œ |
| **`dumps` / `loads`** | Document ì§ë ¬í™”/ì—­ì§ë ¬í™” | Multi-Query RAGì—ì„œ ê²€ìƒ‰ ê²°ê³¼ì˜ ì¤‘ë³µì„ ì œê±°í•  ë•Œ |
| **`invoke`** | Retriever ì‹¤í–‰ | LCEL íŒŒì´í”„ë¼ì¸ê³¼ì˜ í†µí•©, ì¼ê´€ëœ ê²€ìƒ‰ ì„¤ì •ì´ í•„ìš”í•  ë•Œ |
| **`FewShotChatMessagePromptTemplate`** | í”„ë¡¬í”„íŠ¸ì— ì˜ˆì‹œ ì œê³µ | ëª¨ë¸ì˜ ì¶œë ¥ í˜•ì‹ì„ ì œì–´í•˜ê±°ë‚˜ ë³µì¡í•œ ì¶”ë¡ ì„ ìœ ë„í•  ë•Œ |

ì´ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ì˜¬ë°”ë¥´ê²Œ ì´í•´í•˜ê³  ì‚¬ìš©í•˜ë©´ íš¨ìœ¨ì ì´ê³  ì•ˆì •ì ì¸ RAG ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
