# Query Construction (쿼리 구성)

Query Construction은 RAG(Retrieval-Augmented Generation) 시스템에서 사용자의 자연어 질문을 구조화된 데이터베이스 쿼리로 변환하는 핵심 기술입니다.

## 📁 파일 구조

```
query_construction/
├── construction.py       # Query Construction 구현체
└── README.md            # 이 문서
```

## 🤔 Query Construction이 필요한 이유

### 문제 상황: 기존 RAG의 한계

**전통적인 RAG 검색**은 단순한 의미적 유사성(semantic similarity)에만 의존합니다:

```
사용자 질문: "2023년에 올라온 5분 이하 파이썬 튜토리얼을 찾아줘"
기존 방식: "파이썬 튜토리얼" 키워드로만 검색 → 연도, 길이 조건 무시
```

**결과**: 부정확하고 관련성 낮은 결과들이 반환됩니다.

### 해결책: 구조화된 쿼리 생성

**Query Construction**은 자연어 질문을 메타데이터 조건과 함께 처리합니다:

```
사용자 질문: "2023년에 올라온 5분 이하 파이썬 튜토리얼을 찾아줘"
↓ Query Construction ↓
{
    content_search: "파이썬 튜토리얼",
    publish_date: >= 2023-01-01,
    duration: <= 300초
}
```

**결과**: 정확히 조건에 맞는 결과만 반환됩니다.

## 🎯 Query Construction의 핵심 개념

### 1. **의도 파악 (Intent Recognition)**
사용자 질문에서 **검색 의도**와 **필터 조건**을 분리합니다.

**예시 분석:**
- 질문: "최근 인기 있는 머신러닝 강의 중 초보자용을 찾아줘"
- 검색 의도: "머신러닝 강의"
- 필터 조건: "최근", "인기", "초보자용"

### 2. **메타데이터 매핑 (Metadata Mapping)**
자연어 조건을 데이터베이스 스키마에 맞는 구조화된 필터로 변환합니다.

| 자연어 표현 | 구조화된 필터 |
|------------|---------------|
| "최근" | `publish_date >= 2024-01-01` |
| "인기 있는" | `view_count >= 10000` |
| "초보자용" | `difficulty_level = "beginner"` |
| "5분 이하" | `duration <= 300` |

### 3. **하이브리드 검색 (Hybrid Search)**
의미적 검색과 구조화된 필터를 결합합니다.

```
최종 쿼리 = 의미적 검색("머신러닝 강의") 
         + 필터(최근 & 인기 & 초보자용)
```

## 🧠 동작 원리

### 1단계: 질문 분석
```
입력: "2023년 이후 업로드된 React 관련 10분 이하 동영상"

분석 결과:
- 핵심 주제: "React"
- 시간 조건: "2023년 이후"
- 길이 조건: "10분 이하"
```

### 2단계: 구조화
```
구조화된 쿼리:
{
    "content_search": "React",
    "title_search": "React",
    "earliest_publish_date": "2023-01-01",
    "max_length_sec": 600
}
```

### 3단계: 검색 실행
```
1. 의미적 검색: Vector DB에서 "React" 관련 콘텐츠 검색
2. 필터 적용: 날짜, 길이 조건으로 결과 필터링
3. 결과 반환: 조건에 정확히 맞는 결과만 반환
```

## 🎨 Query Construction의 장점

### ✅ **정확성 향상**
- 메타데이터 조건을 정확히 반영
- 불필요한 결과 제거
- 사용자 의도에 부합하는 결과

### ✅ **효율성 증대**
- 검색 범위 사전 축소
- 연산 비용 절감
- 빠른 응답 시간

### ✅ **사용자 경험 개선**
- 더 관련성 높은 결과
- 복잡한 조건 처리 가능
- 자연스러운 질문 방식

### ✅ **확장성**
- 새로운 메타데이터 필드 쉽게 추가
- 다양한 도메인 적용 가능
- 복잡한 비즈니스 로직 처리

## 🌍 실제 활용 사례

### 1. **교육 플랫폼**
```
질문: "초급자를 위한 한국어 파이썬 강의 중 3시간 이하인 것"
변환: language=ko + level=beginner + topic=python + duration<=180min
```

### 2. **동영상 플랫폼**
```
질문: "조회수 만 이상인 최신 요리 영상 중 15분 이하"
변환: category=cooking + views>=10k + duration<=15min + recent=true
```

### 3. **뉴스 검색**
```
질문: "지난 주 기술 뉴스 중 AI 관련 기사"
변환: category=tech + topic=AI + date>=last_week
```

### 4. **전자상거래**
```
질문: "5만원 이하 블루투스 헤드폰 중 평점 4점 이상"
변환: category=headphone + connectivity=bluetooth + price<=50k + rating>=4
```

## 🔄 RAG에서의 Query Construction 역할

### 기존 RAG vs Query Construction RAG

| 구분 | 기존 RAG | Query Construction RAG |
|------|----------|------------------------|
| **검색 방식** | 의미적 유사성만 | 의미적 + 구조적 검색 |
| **필터링** | 사후 필터링 | 사전 필터링 |
| **정확도** | 낮음 | 높음 |
| **효율성** | 낮음 | 높음 |
| **복잡한 조건** | 처리 어려움 | 자연스럽게 처리 |

### Query Construction이 해결하는 RAG 문제들

#### 🚫 **문제 1: 부정확한 검색**
- **기존**: "최근 뉴스" → 모든 뉴스에서 "최근" 키워드 검색
- **개선**: "최근 뉴스" → 실제 날짜 필터 적용

#### 🚫 **문제 2: 메타데이터 무시**
- **기존**: 풍부한 메타데이터를 활용하지 못함
- **개선**: 메타데이터를 적극적으로 활용한 정밀 검색

#### 🚫 **문제 3: 복잡한 조건 처리 불가**
- **기존**: "A이면서 B가 아닌 조건" 처리 어려움
- **개선**: 복잡한 논리 조건도 구조화하여 처리

## 🎯 Query Construction 적용 시나리오

### 시나리오 1: 학습 자료 검색
```
상황: 온라인 교육 플랫폼
사용자: "머신러닝 입문자를 위한 한국어 강의 중 2시간 이하"
처리: 
- 주제: 머신러닝
- 난이도: 입문
- 언어: 한국어  
- 길이: ≤ 2시간
```

### 시나리오 2: 콘텐츠 큐레이션
```
상황: 동영상 추천 시스템
사용자: "주말에 볼 만한 가벼운 예능 프로그램"
처리:
- 장르: 예능
- 분위기: 가벼운
- 시청 시간대: 주말
- 재생시간: 적절한 길이
```

### 시나리오 3: 업무 문서 검색
```
상황: 기업 지식 관리 시스템
사용자: "작년 마케팅 팀에서 작성한 분기별 보고서"
처리:
- 부서: 마케팅
- 연도: 2023
- 문서 유형: 분기별 보고서
- 주기: 분기별
```

## 💡 핵심 인사이트

### Query Construction의 본질
> "Query Construction은 단순한 검색 기술이 아니라, **사용자의 의도를 정확히 이해하고 이를 시스템이 처리할 수 있는 형태로 변환하는 지능**입니다."

### 성공의 핵심 요소
1. **정확한 의도 파악**: 사용자가 정말 원하는 것이 무엇인가?
2. **적절한 구조화**: 의도를 어떻게 시스템 언어로 번역할 것인가?
3. **효율적인 실행**: 구조화된 쿼리를 어떻게 빠르게 처리할 것인가?

---

💡 **결론**: Query Construction은 RAG 시스템의 검색 정확도와 사용자 만족도를 획기적으로 향상시키는 핵심 기술로, 자연어와 구조화된 데이터 사이의 다리 역할을 합니다.
